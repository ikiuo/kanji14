# Kanji14 形式

Unicode の文字コード U+4E03 〜 U+8E0F でバイト列を符号化した形式です。

Unicode 14 では、U+4E03 〜 U+8E0F は全て CJKV Unified Ideographs に含まれています。この範囲の文字コードは、全て表示される文字(漢字)が割り当てられています。<br>(参考ツール：[Unicode Viewer](https://github.com/ikiuo/dhtml-unicode-viewer))

符号化に用いる文字には区切り記号の類や割り当てのない文字コードがないため、単純な処理で符号化と復号が可能です。

## 符号化処理の概要

1. バイト列を 14 ビット単位で分割する(不足分は 0 を追加する)
1. 14 ビットの値に 0x4E10 を加えた Unicode の文字コードにする
1. 不足分を追加した場合は、以下の文字コードを追加する
   - 文字コード : 0x4E10 - (14 - 追加ビット数)

## 復号処理の概要

1. 文字コードから 0x4E10 を引いて 14 ビットのビット列を作る
   - U+4E03 〜 0x8E0F 以外は無視
1. 文字コードが U+4E03 〜 U+4E0F の場合
   - 最終 14 ビット中の有効ビット数を示す
     - 有効ビット数 ＝ 0x4E10 − 文字コード
1. バイト（8 ビット単位）列に変換する

## 注意点

符号化された文字列は UTF-8/16/32 で保存されることを想定しています。他の文字コード体系(例: Windows で使用されるシフトJIS など)への変換は出来ないでしょう。


# バイト列の扱い

バイト列をビット列として扱う手法を示します。

## 1 バイトのビット番号

8 ビット データである 1 バイト中では、ビット番号の最上位ビットを 0 とし、最下位ビットを 7 とします。

|ビット位置|0|1|2|3|4|5|6|7|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|係数|128|64|32|16|8|4|2|1|

## バイト列とビット番号

1 バイト中のビット位置(0〜7)を B として、バイト位置を N とすると、先頭からのビット位置 P は以下とします。
<blockquote>
P ＝ N × 8 ＋ B
</blockquote>

|バイト位置 N|0|1|2|...|
|:-:|:-:|:-:|:-:|:-:|
|ビット位置 P|0..7|8..15|16..23|...|

# 符号化

以下の手順で符号化します

1. バイト列を 14 ビット単位で分割する
1. 区切った 14 ビット値に 0x4E10 を加える
1. バイト列の終わりまで上記を繰り返す
1. バイト列の長さが 7 の倍数でない場合は「終端コード」を追加する

## バイト列の 14 ビット区切り

符号化する 14 ビット区切りのデータ順と先頭からのビット位置の関係は以下とします。

|14ビット順|0|1|2|3|...|
|:-:|:-:|:-:|:-:|:-:|:-:|
|ビット位置|0..13|14..27|28...41|42..55|...|


### 情報文字

区切った 14 ビット値は 0x4E10 を加えた文字コードを**「情報文字」**とします。

- 情報文字：文字コード = 14ビット値 + 0x4E10

## バイト列の長さが 7 の倍数の場合

全て情報文字で構成されます。

## バイト列の長さが 7 の倍数でない場合

バイト列の長さが 7 の倍数でないとき、14 ビット単位に分割すると最後の有効なビット数は 14 未満になります。そのため、残りに 0 を追加する必要があります。

### 0 を追加するビット数

バイト列の長さを 7 で割ったときの余りを剰余バイト数とします。14ビット値のうち対応する有効ビット数と追加ビット数は以下になります。

- 剰余バイト数 ＝ バイト列の長さ ％ 7
- 有効ビット数 ＝ (剰余バイト数 × 8) % 14
- 追加ビット数 ＝ 14 − 有効ビット数

|剰余バイト数|1|2|3|4|5|6|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|有効ビット数|8|2|10|4|12|6|
|追加ビット数|6|12|4|10|2|8|

### 制御文字

有効なビット数を示す文字コードを**「制御文字」**とし以下の文字コードとします。制御文字はデータの終わりを示すとともに、バイト列の復号時に使用されます。

- 制御文字：文字コード ＝ 0x4E10 − 有効ビット数


# 復号

復号では、文字コードの範囲 U+4E03 〜 U+8E0F を対象とし、それ以外の文字コードは無視します。

## 情報文字

情報文字の文字コードから 0x4E10 を引いて 14ビットのデータとすると、情報文字の文字列から 14 ビットのデータ列が生成できます。

情報文字に対応するビット位置は以下になります。

|情報文字位置|0|1|2|3|...|
|:-:|:-:|:-:|:-:|:-:|:-:|
|ビット位置|0..13|14..27|28...41|42..55|...|

これを 8 ビット単位に区切ると、バイト列として復号できます。

### バイト列の最大長

情報文字数とバイト列の最大長の関係は以下になります。

- バイト列の最大長 = ⌊(情報文字数 × 14) ÷ 8⌋
  - <small> ⌊x⌋ は床関数 floor(x) です</small>

バイト列の「長さ」ではなく「最大長」です。制御文字次第でバイト列の長さは、最大長より短くなります。

## 制御文字がない場合

バイト列の長さは、バイト列の最大長と同じです。

## 制御文字がある場合

制御文字 U+4E03 〜 U+4E0F はデータの終わりとともに、最後の 14 ビット中で先頭から有効なビット数を示しています。

- 有効ビット数 ＝ U+4E10 - 制御文字コード
- 追加ビット数 ＝ 14 - 有効ビット数

### バイト列の長さ

追加ビット数が 8 未満の場合は「バイト列の長さ」は「最大長」と同じですが、8 以上の場合は、最大長から -1 します。

# 実行例

Python プログラム kanji14.py を bzip2 圧縮したバイナリをを Kanji14 形式にする。

```
$ bzip2 -c kanji14.py | python3 kanji14.py -e -w 40
度璓狕佩垤莩悹蚞丐灟谑剤帐哏踏薷嚁滻踏渎我泆睼蒈蓋稺嬪佐悒坄芶譆獟缣庮偹兓梪侣荂
暯睝仠桹嬣判蒶床渐兓廠侰丐劙五懚瑄苢喹瘪媝典湹瘐咐蛙狣愙牴儒婝吘纓徶丑伲園嬝乺曤
艴盠艄乂宸世灰乛衽籲譖拜蕛濉泣装嶱找揬嗙崨僝蕉壝弚斒嘳捀瑬竓焐梌琜呠庮扇塢劰擪桠
蔡仫岷冋摔撩代慴妄刴澰溙納槽瓈拯舲椓曭蛰纊挏刄纲炚谑覘竄恫莘襋讵写燑捃曘葎屘滳螌
眲癿悁檾嚞憻枸莾禖皹苂腁罹孨榧墬孄涟蝖塁琳繽砪灸苆岅塥蝎圀殧唚瞢窝漽岔葰焔捧为梭
秵偢華皯午撍橩懧壧冘盢滗愹慶嶘蚛笯窨簌僷蓅嚺皼讀蘲準桇信姜嘹勽潭嬘噯萛厨妌臟届腃
愩樳徚萓覍费裥務灯圌爠牻婀磟櫯莖濈款溼旮贯呢埤劣弲圐折嫓溔腡甡佃穸洞掅懲租墢祥汞
扎戰縩游沞璸唠扢嘖皊奒胓侖讕睵蜔嗹妽坿慪簢埕盯捓悩扜岋諻敳繠榁忀朣匦禭燓睩敬曷粜
守掀勅蠒廡催謵旁擂航竱咜耤事戈獞慽篷紥蒑笥垢欉諜啢拟菷窿藵楨繅濣臱茺礴曪憼楆務豱
仑皖灞曝循仂冱壬峃嵒瘢峂奠艽袃段祺喔槄咰断殂灠洆冹煛搮扨褪亠恠垂卉炐椯俠庸船瞖簰
才绌罍忊矠品纣兄弜佱蔹脖捡瀨艻華焁誂膺儃虄沼蛬畋褆虦褵匷舐翌声哤嘚堕縧朄眩拼娉搇
句湨緁嬊枰屐枉噩竱臀垘堨娃爑幫佴扂蓗襁婂呑他癅刜蟎窚國挱烹擻俖恾脻壝厮蚼艆熓嵄衒
壦啠楳哭誫牘紋膵緱脻籗僫媔桕坰樒絩琂卒碨嶹圻凎貵喩砙厕蒉蜻煁溴跐其磀蘪嘍裋勚塔椧
呔斠桖悇瞻褔恳桉谣梸厲囵潐峅划睟偷濸砶稛扮斫掆屇恳唎娶恫穛翱簡睑廤獿樛癁稫哮曽今
褝呶嫣糱篭庫誫罃噀恕兆繹墲柨苍皜垵僁役嬢尵爼厥橭唱勄祡扭揕獒呿懙桰碀嘴峬膁瀭嵤暚
褂芋断侥灁坑甿愾検撂惈猢痴奲漫梱權悹坵灤在磡梓廖婽兟趃幠桳弝孊茰幝囈桭失筟秬簼匡
怡界奒平珓礩咲瘓瀝婰敫覧坫狥晤呐椳毙殐臠襪省斆滿蜪芅罀僫綐窤矼腨惶貗磲楅祚璷覍襧
氪檼罡梂桡乘尐肢苆胭樳玞櫿咻捵浩噇槬埖扒索嶇伮怿惣揥癧祚荻挔唨盕膄犃紸衉傶兓嚨崓
寠詪濁妶貓翍恱甞濬焕廕約萪熎貕膐虲慖婭僳覊砘溼摵罝溴繐恰嬦囯篪貁塄椝蒕茿喨朐襄啌
掴叴祠昵汹筇夁橢蘶檢谩剪撏缬勛憎拯揑腣贉肸杛婥脟娘澈臇蠝纻昽簹歕胾姝亊戏召牣潒庤
碮困丆
```

復号してソース コードを確認する

```
$ bzip2 -c kanji14.py | python3 kanji14.py -e | python3 kanji14.py -d | bzip2 -cd
~~~ 結果は省略 ~~~
```
