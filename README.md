# Kanji14 形式

Unicode の文字コード U+4E03 〜 U+8E0F でバイト列を符号化した形式です。

Unicode では、U+4E03 〜 U+8E0F は全て CJKV Unified Ideographs に含まれています。この範囲の文字コードは、全て表示される文字(漢字)が割り当てられています。<br>(参考ツール：[Unicode Viewer](https://github.com/ikiuo/dhtml-unicode-viewer))

符号化に用いる文字には区切り記号の類や割り当てのない文字コードがないため、単純な処理で符号化と復号が可能です。

## 符号化処理の概要

1. バイト列を 14 ビット単位で分割する(不足分は 0 を追加する)
1. 14 ビットの値に 0x4E10 を加えた Unicode の文字コードにする
1. 不足分を追加した場合は、以下の文字コードを追加する
   - 文字コード : 0x4E10 - (14 - 追加ビット数)

## 復号処理の概要

1. 文字コードから 0x4E10 を引いて 14 ビットのビット列を作る
   - U+4E03 〜 0x8E0F 以外は無視
1. 文字コードが U+4E03 〜 U+4E0F の場合
   - 最終 14 ビット中の有効ビット数を示す
     - 有効ビット数 ＝ 0x4E10 − 文字コード
1. バイト（8 ビット単位）列に変換する

## 注意点

符号化された文字列は UTF-8/16/32 で保存されることを想定しています。他の文字コード体系(例: Windows で使用されるシフトJIS など)への変換は出来ないでしょう。


# バイト列の扱い

バイト列をビット列として扱う手法を示します。

## 1 バイトのビット番号

8 ビット データである 1 バイト中では、ビット番号の最上位ビットを 0 とし、最下位ビットを 7 とします。

|ビット位置|0|1|2|3|4|5|6|7|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|係数|128|64|32|16|8|4|2|1|

## バイト列とビット番号

1 バイト中のビット位置(0〜7)を B として、バイト位置を N とすると、先頭からのビット位置 P は以下とします。
<blockquote>
P ＝ N × 8 ＋ B
</blockquote>

|バイト位置 N|0|1|2|...|
|:-:|:-:|:-:|:-:|:-:|
|ビット位置 P|0..7|8..15|16..23|...|

# 符号化

以下の手順で符号化します

1. バイト列を 14 ビット単位で分割する
1. 区切った 14 ビット値に 0x4E10 を加える
1. バイト列の終わりまで上記を繰り返す
1. バイト列の長さが 7 の倍数でない場合は「終端コード」を追加する

## バイト列の 14 ビット区切り

符号化する 14 ビット区切りのデータ順と先頭からのビット位置の関係は以下とします。

|14ビット順|0|1|2|3|...|
|:-:|:-:|:-:|:-:|:-:|:-:|
|ビット位置|0..13|14..27|28...41|42..55|...|


### 情報文字

区切った 14 ビット値は 0x4E10 を加えた文字コードを「情報文字」とします。

- 情報文字：文字コード = 14ビット値 + 0x4E10

## バイト列の長さが 7 の倍数の場合

全て情報文字で構成されます。

## バイト列の長さが 7 の倍数でない場合

バイト列の長さが 7 の倍数でないとき、14 ビット単位に分割すると最後の有効なビット数は 14 未満になります。そのため、残りに 0 を追加する必要があります。

### 0 を追加するビット数

バイト列の長さを 7 で割ったときの余りを剰余バイト数とします。14ビット値のうち対応する有効ビット数と追加ビット数は以下になります。

- 剰余バイト数 ＝ バイト列の長さ ％ 7
- 有効ビット数 ＝ (剰余バイト数 × 8) % 14
- 追加ビット数 ＝ 14 − 有効ビット数

|剰余バイト数|1|2|3|4|5|6|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|有効ビット数|8|2|10|4|12|6|
|追加ビット数|6|12|4|10|2|8|

### 制御文字

有効なビット数を示す文字コードを「制御文字」とし以下の文字コードとします。制御文字はデータの終わりを示すとともに、バイト列の復号時に使用されます。

- 制御文字：文字コード ＝ 0x4E10 − 有効ビット数


# 復号

復号では、文字コードの範囲 U+4E03 〜 U+8E0F を対象とし、それ以外の文字コードは無視します。

## 情報文字

情報文字の文字コードから 0x4E10 を引いて 14ビットのデータとすると、情報文字の文字列から 14 ビットのデータ列が生成できます。

情報文字に対応するビット位置は以下になります。

|情報文字位置|0|1|2|3|...|
|:-:|:-:|:-:|:-:|:-:|:-:|
|ビット位置|0..13|14..27|28...41|42..55|...|

これを 8 ビット単位に区切ると、バイト列として復号できます。

### バイト列の最大長

情報文字数とバイト列の最大長の関係は以下になります。

- バイト列の最大長 = ⌊(情報文字数 × 14) ÷ 8⌋
  - <small> ⌊x⌋ は床関数 floor(x) です</small>

バイト列の「長さ」ではなく「最大長」です。制御文字次第でバイト列の長さは、最大長より短くなります。

## 制御文字がない場合

バイト列の長さは、バイト列の最大長と同じです。

## 制御文字がある場合

制御文字 U+4E03 〜 U+4E0F はデータの終わりとともに、最後の 14 ビット中で先頭から有効なビット数を示しています。

- 有効ビット数 ＝ U+4E10 - 制御文字コード
- 追加ビット数 ＝ 14 - 有効ビット数

### バイト列の長さ

追加ビット数が 8 未満の場合は「バイト列の長さ」は「最大長」と同じですが、8 以上の場合は、最大長から -1 します。

# 実装例

- Python : kanji14.py
- JavaScript : kanji14.js
- C : kanji14.h kanji14.c

### 実行例 (Python)

Python プログラム kanji14.py を bzip2 圧縮したバイナリをを Kanji14 形式にする。

```
$ bzip2 -c kanji14.py | python3 kanji14.py -e -w 40
度璓狕佩垤莥莵猕丐槯谑剤帐咯踍薷嚁滻踏渎我微蔦柭槊秆瘚莺劢桐噽墫孂梳芨茟庝丑瞰茅
侠梮瞠愳恝嬩睄侶渐丐丐怲璶捍獂瓪矴疹笠蒣倐兝嵖皉廣荄屰偀愠儐琙盘栨佀徙漲弖瞶恽基
杍愶慤譐縶煑皊慺木姎殙圖肂竨菿櫎簍斆澤吣浬檥峍櫛碾匴裲俉孁程舙単媪梚袛撤簬内幺櫇
涑匶幄苩僨渑儔儆汎省禎款詋蛘樰岊嗾蔤胔詖荹綝襄网畗瞿崋虖圤西枝尩煎癢璐艬堒媓舋欌
砘湞睗犝塔耙幥燉璽禥漶訝解壹曁亴虗撋摩倜洐故倐棢埻濧礎庱她滁垚繴艀溚芞串獙刷吰奒
衤育溆畸孉翁吽橏懷胬聄菇沆牡圆卡篗倯吘瘌劦括嗋蕛嵃乮穅禖窸琜砘満庩籄瀰衊旓捦袌礍
媺獭睲產巄堠睡縦婹倬喻壓聫掣嬗烜胯挛襇瓕楜蔡唲縴圚烡刳碚宯匱蔀榥窬磢悫椼欙罽盉槱
溤縠傀矓挺讚羦以氁殕刑硆耣蜫楾蓱氝虶彂暃唬恝媣組汫剼徧苻緳巄謠灐杀窔怹噺暟呪诚穝
墨欕箑倍囑扳詧蟝兤尥茻袧唊澍妾桋嗉肔眪妬汑槞瘰渝垔亅蟗蟚戢拪璫暆絩桮泃梷戝旑瘾噗
悈婱滒湗仦羑蘤藵糭唞哛冲熫腽衊砫斕婯眑澮却堠勤僪妩蜢號瑾撪医惀睱嬆蕐涘婤尻嫑袨倸
拗僠倲譲笽簫蘎絼灑蛮皂圣圵儙紕艄害艢梅幆擧冼哨翆羥覇嗉拹樼很癨兀禥礅猕恰谙傰葩媱
莬幈祺窋荡摪畏皾箮儚嗳粤恵功拎蚚兂呝艝拀嚣員绾獺笠袐蛘溕童腒噞溾竉拯涹脈梀溨檶蜽
精噖演腢揂忛樛湁稫榇劘匈笃翀绅煅杼衴楛诽舓癙劚偬污爸厰蛮柃慈囒檤矰暭焤菙愠腪薿偓
庰岉甃噎跡呒瞁桌断桂姠禝墱綍桤犴痮奪潳挩诂竁堐硑梥褨罀淛弔蒨纖苹摒卄烡瞋呓梯翖苀
墒砡蓨刓呇扂岒昗娪曒蓟瓃揋蒻傳氖籆枾暾璃籇譵砞慙甞悽蝓睏壕皅昢筩荏菭盘嬉懺戼婩堰
圓渞聕睽珊瘝蕥翔梽接询图肘燁砾功让咤攵炷畸搵燯抱柰攛垳甹扆憙佣侱牞檞坞攥兹别岸婄
俐袡硥呶梤脕螎蜩碷滉調琡亾侰汒櫤測牄掳夥聃嘴煞埢褁殨妩汋澠凡湷筪湫獚厂撒袣惃僕俁
妯伤猭蜒滧虮脌咉瘍惻砩峟蕘蛃剮苨焆侟抧婭波蛢檟砾蜲甚劒裢肒渐与
```

復号してソース コードを確認する

```
$ bzip2 -c kanji14.py | python3 kanji14.py -e | python3 kanji14.py -d | bzip2 -cd
~~~ 結果は省略 ~~~
```
